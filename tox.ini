[tox]
envlist = py311, lint, type, docs, ci, clean, sync, precommit, mock-upload, install
skip_missing_interpreters = true
requires =
    tox-uv>=1.0

[testenv:sync]
description = Sync uv environment dependencies and verify installation
skip_install = true
deps =
allowlist_externals =
    bash
commands =
    bash -c "if [ ! -d .venv ]; then uv venv --python 3.11; fi"
    uv sync --active
    uv pip check
    bash -c "echo 'Dependencies synced successfully. Virtual environment ready.'"

[testenv:clean]
description = Remove all build artifacts, cache files, and temporary directories
skip_install = true
allowlist_externals =
    bash
commands =
    bash -c "echo 'Cleaning build artifacts and cache files...'"
    bash -c "rm -rf .tox dist build *.egg-info htmlcov .coverage coverage.xml .pytest_cache"
    bash -c "find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true"
    bash -c "find . -name '*.pyc' -delete 2>/dev/null || true"
    bash -c "find . -name '*.pyo' -delete 2>/dev/null || true"
    bash -c "echo 'Cleanup completed.'"

[testenv:lint]
description = Run Ruff checks with auto-fixing
skip_install = true
deps =
    ruff
allowlist_externals =
    echo
commands =
    ruff check src tests --fix --unsafe-fixes
    ruff format src tests
    black --check --diff src tests
    echo "Lint checks passed"

[testenv:type]
description = Run comprehensive mypy type checks
skip_install = false
deps =
    mypy
basepython = python3.11
allowlist_externals =
    echo
commands =
    mypy --explicit-package-bases --ignore-missing-imports src
    echo "Type checking completed"

[testenv:docs]
description = Build Sphinx documentation
skip_install = true
deps =
    sphinx>=5.0.0
    sphinx-rtd-theme>=1.2.0
basepython = python3.11
allowlist_externals =
    echo
commands =
    sphinx-build templates/docs docs/_build/html
    echo "Documentation built: docs/_build/html/index.html"

[testenv:pytest]
description = Run tests under coverage with detailed reporting
skip_install = false
deps =
    pytest
    coverage
    pytest-cov
    pytest-xdist
basepython = python3.11
allowlist_externals =
    echo
commands =
    pytest tests/ -v --tb=short --strict-markers --cov=src --cov-report=term-missing:skip-covered --cov-report=html --cov-report=xml -n auto
    echo "Test results: htmlcov/index.html, coverage.xml"

[testenv:precommit]
description = Run pre-commit hooks with comprehensive checks
skip_install = true
deps =
    pre-commit
allowlist_externals =
    echo
commands =
    pre-commit install --install-hooks
    pre-commit run --all-files --verbose
    echo "Pre-commit checks completed"

[testenv:ci]
description = Run the full CI pipeline with auto-fixing capabilities and comprehensive checks
skip_install = false
deps =
    ruff
    black
    isort
    mypy
    pre-commit
    pytest
    coverage
    pytest-cov
    pytest-xdist
basepython = python3.11
allowlist_externals =
    bash
commands =
    bash -c "echo '=== Running comprehensive cleanup ==='"
    python -c "import os, shutil; [shutil.rmtree(d, ignore_errors=True) for root, dirs, files in os.walk('.') for d in dirs if d.endswith('.egg-info')]; print('Egg-info folders removed')"
    bash -c "echo '=== Running pre-commit hooks ==='"
    bash -c "pre-commit run --all-files --verbose"
    bash -c "echo '=== Running lint checks with auto-fix ==='"
    ruff check src tests --fix --unsafe-fixes
    isort src tests
    black src tests
    isort --check-only --diff src tests
    black --check --diff src tests
    bash -c "echo '=== Running type checks ==='"
    mypy --explicit-package-bases --ignore-missing-imports --no-error-summary src
    bash -c "echo '=== Running tests with coverage ==='"
    pytest tests/ -v --tb=short --strict-markers --cov=src --cov-report=term-missing --cov-report=html --cov-report=xml --cov-fail-under=50 -n auto
    bash -c "echo '=== CI pipeline completed successfully ==='"

[testenv:mock-upload]
description = Build the package and check if it's ready for PyPI upload
skip_install = true
deps =
    build
    twine
allowlist_externals =
    bash
commands =
    bash -c "echo '=== Cleaning previous builds ==='"
    bash -c "rm -rf dist/"
    bash -c "echo '=== Building package ==='"
    python -m build
    bash -c "echo '=== Checking package for PyPI upload ==='"
    twine check dist/*
