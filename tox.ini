# tox configuration for python-project-generator

[tox]
envlist = clean, clean_all, setup, sync, py311, lint, type, precommit, pytest, smoke_test, docs, ci, mock-upload, install
isolated_build = true
skip_missing_interpreters = true
requires =
    tox-uv>=1.0

# Define directories to check and clean
check_dirs = src tests templates

[testenv:setup]
description = Complete project setup from scratch (creates venv, syncs dependencies)
skip_install = true
deps =
allowlist_externals =
    bash
    uv
commands =
    bash -c "if [ ! -d .venv ]; then uv venv --python 3.11; fi"
    uv sync --active
    bash -c "echo 'Setup complete! Use: source .venv/bin/activate'"

[testenv:sync]
description = Sync uv environment dependencies and verify installation
skip_install = true
deps =
allowlist_externals =
    bash
commands =
    bash -c "if [ ! -d .venv ]; then uv venv --python 3.11; fi"
    uv sync --active
    uv pip check
    bash -c "echo 'Dependencies synced successfully. Virtual environment ready.'"

[testenv:clean]
description = Delete all compiled Python files and cache directories
skip_install = true
deps =
allowlist_externals =
    echo
commands =
    python -c "import os, shutil; dirs = '{[tox]check_dirs}'.split(); [shutil.rmtree(os.path.join(d, '__pycache__'), ignore_errors=True) for d in dirs if os.path.exists(os.path.join(d, '__pycache__'))]"
    python -c "import os, shutil; dirs = '{[tox]check_dirs}'.split(); [shutil.rmtree(d, ignore_errors=True) for root, dirs_list, files in os.walk('.') for d in dirs_list if d.endswith('.egg-info') and any(root.startswith(target_dir + '/') for target_dir in dirs)]"
    python -c "import os, glob, shutil; [os.remove(f) for f in glob.glob('**/*.pyc', recursive=True) if os.path.exists(f) and not f.startswith('.venv/')]"
    python -c "import os, glob, shutil; [os.remove(f) for f in glob.glob('**/*.pyo', recursive=True) if os.path.exists(f) and not f.startswith('.venv/')]"
    python -c "import os, glob, shutil; [shutil.rmtree(d, ignore_errors=True) for d in glob.glob('**/__pycache__', recursive=True) if os.path.exists(d) and not d.startswith('.venv/')]"
    python -c "import os, glob, shutil; [shutil.rmtree(d, ignore_errors=True) for d in glob.glob('**/*.egg-info', recursive=True) if os.path.exists(d) and not d.startswith('.venv/')]"
    python -c "import os, glob, shutil; [shutil.rmtree(d, ignore_errors=True) for d in glob.glob('**/.pytest_cache', recursive=True) if os.path.exists(d) and not d.startswith('.venv/')]"
    python -c "import os, glob, shutil; [os.remove(f) for f in glob.glob('**/.coverage', recursive=True) if os.path.exists(f) and not f.startswith('.venv/')]"
    python -c "import os, glob, shutil; [shutil.rmtree(d, ignore_errors=True) for d in glob.glob('**/htmlcov', recursive=True) if os.path.exists(d) and not d.startswith('.venv/')]"
    python -c "import os, glob, shutil; [shutil.rmtree(d, ignore_errors=True) for d in glob.glob('**/.mypy_cache', recursive=True) if os.path.exists(d) and not d.startswith('.venv/')]"
    python -c "import os, glob, shutil; [shutil.rmtree(d, ignore_errors=True) for d in glob.glob('**/.ruff_cache', recursive=True) if os.path.exists(d) and not d.startswith('.venv/')]"
    echo "Clean complete"

[testenv:clean_all]
description = Delete all project log and output directories comprehensively
skip_install = true
deps =
allowlist_externals =
    echo
commands =
    tox -e clean
    python -c "import shutil, os; dirs = ['htmlcov','test-results']; files = ['.coverage','coverage.xml']; [shutil.rmtree(d, ignore_errors=True) for d in dirs if os.path.exists(d)]; [os.remove(f) for f in files if os.path.exists(f)]; print('Additional directories and files cleaned')"
    echo "Clean_all complete - all cache, log, and output directories removed"

[testenv:lint]
description = Run Ruff, Black, and isort checks with auto-fixing
skip_install = true
deps =
    ruff
    black
    isort
allowlist_externals =
    echo
commands =
    ruff check --fix --unsafe-fixes --exclude templates
    isort --check-only --diff src tests
    black --check --diff src tests
    echo "Lint checks passed"

[testenv:type]
description = Run comprehensive mypy type checks
skip_install = false
deps =
    mypy
basepython = python3.11
allowlist_externals =
    echo
commands =
    mypy --explicit-package-bases --ignore-missing-imports src tests
    echo "Type checking completed"

[testenv:py311]
description = Run tests under Python 3.11
skip_install = false
deps =
    pytest
    coverage
    pytest-cov
    pytest-xdist
basepython = python3.11
allowlist_externals =
    echo
commands =
    pytest tests/ -v --tb=short --strict-markers --cov=src --cov-report=term-missing:skip-covered --cov-report=html --cov-report=xml -n auto
    echo "Python 3.11 tests completed"

[testenv:docs]
description = Build Sphinx documentation
skip_install = true
deps =
    sphinx>=5.0.0
    sphinx-rtd-theme>=1.2.0
basepython = python3.11
allowlist_externals =
    echo
commands =
    sphinx-build templates/docs docs/_build/html
    echo "Documentation built: docs/_build/html/index.html"

[testenv:pytest]
description = Run tests under coverage with detailed reporting
skip_install = false
deps =
    pytest
    coverage
    pytest-cov
    pytest-xdist
basepython = python3.11
allowlist_externals =
    echo
commands =
    pytest tests/ -v --tb=short --strict-markers --cov=src --cov-report=term-missing:skip-covered --cov-report=html --cov-report=xml -n auto
    echo "Test results: htmlcov/index.html, coverage.xml"

[testenv:smoke_test]
description = Run smoke tests (fast tests only) with quick feedback
skip_install = false
deps =
    pytest
    coverage
    pytest-cov
basepython = python3.11
allowlist_externals =
    echo
commands =
    coverage run -m pytest tests/test_smoke.py -v --tb=short --durations=10
    coverage report -m --include="*/test_smoke*" --skip-covered
    echo "Smoke tests completed"

[testenv:precommit]
description = Run pre-commit hooks with comprehensive checks
skip_install = true
deps =
    pre-commit
allowlist_externals =
    echo
commands =
    pre-commit install --install-hooks
    pre-commit run --all-files --verbose
    echo "Pre-commit checks completed"

[testenv:ci]
description = Run the full CI pipeline with auto-fixing capabilities and comprehensive checks
skip_install = false
deps =
    ruff
    black
    isort
    mypy
    pre-commit
    pytest
    coverage
    pytest-cov
    pytest-xdist
basepython = python3.11
allowlist_externals =
    bash
commands =
    bash -c "echo '=== Running comprehensive cleanup ==='"
    python -c "import os, shutil; [shutil.rmtree(d, ignore_errors=True) for root, dirs, files in os.walk('.') for d in dirs if d.endswith('.egg-info')]; print('Egg-info folders removed')"
    bash -c "echo '=== Running pre-commit hooks ==='"
    bash -c "pre-commit run --all-files || true"
    bash -c "echo '=== Running lint checks with auto-fix ==='"
    ruff check src tests --fix --unsafe-fixes
    isort --check-only --diff src tests
    black --check --diff src tests
    bash -c "echo '=== Running type checks ==='"
    mypy --explicit-package-bases --ignore-missing-imports --no-error-summary src tests
    bash -c "echo '=== Running tests with coverage ==='"
    pytest tests/ -v --tb=short --strict-markers --cov=src --cov-report=term-missing --cov-report=html --cov-report=xml --cov-fail-under=50 -n auto
    bash -c "echo '=== CI pipeline completed successfully ==='"

[testenv:mock-upload]
description = Build the package and check if its ready for PyPI upload
skip_install = true
deps =
    build
    twine
allowlist_externals =
    bash
commands =
    bash -c "echo '=== Cleaning previous builds ==='"
    bash -c "rm -rf dist/"
    bash -c "echo '=== Building package ==='"
    python -m build
    bash -c "echo '=== Checking package for PyPI upload ==='"
    twine check dist/*

[gh-actions]
python =
    3.11: py311, lint, type
